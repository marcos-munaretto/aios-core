# Story 3.16: db-sage Integration Mapping

**Created:** 2025-10-29  
**Purpose:** Map existing db-sage artifacts to framework integration targets  
**Status:** Ready for Development  
**Pattern:** Integration story (80% work already done)

---

## Executive Summary

**Scope:** Integrate existing db-sage agent and artifacts into AIOS core framework  
**Source:** `db-sage/` directory (root level)  
**Target:** `aios-fullstack/aios-core/` structure  
**Artifacts:** 1 agent, 11 tasks, 6 templates, 3 documentation files  
**Integration Pattern:** File migration + configuration updates + testing

---

## Artifact Inventory

### ‚úÖ Agent (1 file)

| Source | Target | Status | Integration Pattern |
|--------|--------|--------|---------------------|
| `db-sage/agents/db-sage.md` | `aios-fullstack/aios-core/agents/db-sage.md` | ‚úÖ EXISTS | Direct copy, verify format |

**Agent Details:**
- **Name:** DB Sage
- **ID:** db-sage
- **Title:** Database Architect & Operations Engineer
- **Icon:** üóÑÔ∏è
- **Lines:** 213 lines (production-ready)
- **Commands:** 20+ commands (bootstrap, migrate, smoke-test, rls-audit, etc.)
- **Tools:** Supabase MCP configured
- **Persona:** Complete database lifecycle expertise

**Integration Notes:**
- Format matches standard AIOS agent format ‚úÖ
- Uses standard `.aios-core/{type}/{name}` paths ‚úÖ
- Slash command: `/AIOS/agents/db-sage` ‚úÖ
- No changes needed to agent file structure

---

### ‚úÖ Tasks (11 files)

| Source | Target | Status | Integration Pattern | Priority |
|--------|--------|--------|---------------------|----------|
| `db-sage/tasks/db-bootstrap.md` | `aios-fullstack/aios-core/tasks/db-bootstrap.md` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/tasks/db-apply-migration.md` | `aios-fullstack/aios-core/tasks/db-apply-migration.md` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/tasks/db-smoke-test.md` | `aios-fullstack/aios-core/tasks/db-smoke-test.md` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/tasks/db-rls-audit.md` | `aios-fullstack/aios-core/tasks/db-rls-audit.md` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/tasks/db-rollback.md` | `aios-fullstack/aios-core/tasks/db-rollback.md` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/tasks/db-snapshot.md` | `aios-fullstack/aios-core/tasks/db-snapshot.md` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/tasks/db-dry-run.md` | `aios-fullstack/aios-core/tasks/db-dry-run.md` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/tasks/db-env-check.md` | `aios-fullstack/aios-core/tasks/db-env-check.md` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/tasks/db-explain.md` | `aios-fullstack/aios-core/tasks/db-explain.md` | ‚úÖ EXISTS | Direct copy | LOW |
| `db-sage/tasks/db-impersonate.md` | `aios-fullstack/aios-core/tasks/db-impersonate.md` | ‚úÖ EXISTS | Direct copy | LOW |
| `db-sage/tasks/db-verify-order.md` | `aios-fullstack/aios-core/tasks/db-verify-order.md` | ‚úÖ EXISTS | Direct copy | LOW |

**Task Categories:**

**HIGH Priority (Operations):**
- `db-bootstrap` - Scaffold Supabase project structure
- `db-apply-migration` - Run migrations with snapshots
- `db-smoke-test` - Comprehensive smoke tests
- `db-rls-audit` - RLS policy audit

**MEDIUM Priority (Safety):**
- `db-rollback` - Restore snapshots or rollback scripts
- `db-snapshot` - Create schema-only snapshots
- `db-dry-run` - Test migrations safely
- `db-env-check` - Validate environment variables

**LOW Priority (Utilities):**
- `db-explain` - Query explanation
- `db-impersonate` - User emulation for RLS testing
- `db-verify-order` - DDL ordering lint

**Integration Notes:**
- All tasks follow standard AIOS task format ‚úÖ
- Use `elicit: true` for user interaction ‚úÖ
- Reference `.aios-core/` paths ‚úÖ
- May need path verification after migration

---

### ‚úÖ Templates (6 files)

| Source | Target | Status | Integration Pattern | Priority |
|--------|--------|--------|---------------------|----------|
| `db-sage/templates/schema-design-tmpl.yaml` | `aios-fullstack/aios-core/templates/schema-design-tmpl.yaml` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/templates/migration-plan-tmpl.yaml` | `aios-fullstack/aios-core/templates/migration-plan-tmpl.yaml` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/templates/rls-policies-tmpl.yaml` | `aios-fullstack/aios-core/templates/rls-policies-tmpl.yaml` | ‚úÖ EXISTS | Direct copy | HIGH |
| `db-sage/templates/index-strategy-tmpl.yaml` | `aios-fullstack/aios-core/templates/index-strategy-tmpl.yaml` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/templates/tmpl-rls-kiss-policy.sql` | `aios-fullstack/aios-core/templates/tmpl-rls-kiss-policy.sql` | ‚úÖ EXISTS | Direct copy | MEDIUM |
| `db-sage/templates/tmpl-smoke-test.sql` | `aios-fullstack/aios-core/templates/tmpl-smoke-test.sql` | ‚úÖ EXISTS | Direct copy | MEDIUM |

**Template Categories:**

**HIGH Priority (Core Design):**
- `schema-design-tmpl.yaml` - Comprehensive schema design template
- `migration-plan-tmpl.yaml` - Migration planning template
- `rls-policies-tmpl.yaml` - RLS policy design template

**MEDIUM Priority (Optimization):**
- `index-strategy-tmpl.yaml` - Index strategy planning
- `tmpl-rls-kiss-policy.sql` - KISS policy template
- `tmpl-smoke-test.sql` - Smoke test template

**Integration Notes:**
- All templates follow standard AIOS template format ‚úÖ
- YAML templates use standard structure ‚úÖ
- SQL templates are reference files ‚úÖ
- May need registration in core-config.yaml

---

### ‚úÖ Documentation (3 files)

| Source | Target | Status | Integration Pattern | Priority |
|--------|--------|--------|---------------------|----------|
| `db-sage/VALIDATION-supabase-docs.md` | `aios-fullstack/aios-core/data/validation-supabase-docs.md` | ‚úÖ EXISTS | Move to data/ | MEDIUM |
| `db-sage/SCHEMA-COMPARISON-SQLITE-SUPABASE.md` | `docs/architecture/schema-comparison-sqlite-supabase.md` | ‚úÖ EXISTS | Move to docs/ | LOW |
| `db-sage/README.md` | Archive (or move to docs/) | ‚úÖ EXISTS | Archive | LOW |

**Integration Notes:**
- VALIDATION file ‚Üí Knowledge base (data/)
- Comparison doc ‚Üí Architecture docs
- README ‚Üí Archive or convert to docs

---

## Integration Workflow

### Step 1: Audit Existing Artifacts (1h)

**Actions:**
- [ ] Verify all 11 tasks exist and are complete
- [ ] Verify all 6 templates exist and are valid
- [ ] Verify agent file format matches standard
- [ ] Check for any hard-coded paths
- [ ] Document any missing dependencies

**Validation:**
- ‚úÖ All artifacts exist
- ‚úÖ Formats match AIOS standards
- ‚úÖ No blocking issues found

---

### Step 2: Migrate Agent File (30min)

**Actions:**
- [ ] Copy `db-sage/agents/db-sage.md` ‚Üí `aios-fullstack/aios-core/agents/db-sage.md`
- [ ] Verify file format matches other agents
- [ ] Test slash command: `/AIOS/agents/db-sage`
- [ ] Verify agent activation works

**Validation:**
- ‚úÖ Agent file in correct location
- ‚úÖ Format matches standard
- ‚úÖ Slash command works
- ‚úÖ Agent activates successfully

---

### Step 3: Migrate Task Files (2h)

**Actions:**
- [ ] Copy 11 task files to `aios-fullstack/aios-core/tasks/`
- [ ] Verify task format matches standard
- [ ] Check path references (`.aios-core/` paths)
- [ ] Test task discovery via agent dependencies
- [ ] Verify tasks execute correctly

**Priority Order:**
1. HIGH priority tasks first (bootstrap, apply-migration, smoke-test, rls-audit)
2. MEDIUM priority tasks (rollback, snapshot, dry-run, env-check)
3. LOW priority tasks (explain, impersonate, verify-order)

**Validation:**
- ‚úÖ All 11 tasks migrated
- ‚úÖ Tasks discoverable via agent
- ‚úÖ Tasks execute successfully
- ‚úÖ Path references resolve correctly

---

### Step 4: Migrate Template Files (1h)

**Actions:**
- [ ] Copy 6 template files to `aios-fullstack/aios-core/templates/`
- [ ] Verify template format matches standard
- [ ] Test template loading via `create-doc` task
- [ ] Verify templates validate correctly

**Priority Order:**
1. HIGH priority templates first (schema-design, migration-plan, rls-policies)
2. MEDIUM priority templates (index-strategy, sql templates)

**Validation:**
- ‚úÖ All 6 templates migrated
- ‚úÖ Templates load correctly
- ‚úÖ Templates validate against standards
- ‚úÖ Accessible via create-doc task

---

### Step 5: Update Configuration (30min)

**Actions:**
- [ ] Register templates in `core-config.yaml` (if templates section exists)
- [ ] Register tasks in `core-config.yaml` (if tasks section exists)
- [ ] Verify registration format matches existing patterns
- [ ] Maintain alphabetical order

**Configuration Updates:**

**core-config.yaml** (if templates section exists):
```yaml
templates:
  database:
    - schema-design-tmpl
    - migration-plan-tmpl
    - rls-policies-tmpl
    - index-strategy-tmpl
    - tmpl-rls-kiss-policy
    - tmpl-smoke-test
```

**core-config.yaml** (if tasks section exists):
```yaml
tasks:
  database:
    - db-bootstrap
    - db-apply-migration
    - db-smoke-test
    - db-rls-audit
    - db-rollback
    - db-snapshot
    - db-dry-run
    - db-env-check
    - db-explain
    - db-impersonate
    - db-verify-order
```

**Note:** Agents are discovered via file system (no registry needed)

**Validation:**
- ‚úÖ Configuration updated correctly
- ‚úÖ Format matches existing patterns
- ‚úÖ Alphabetical order maintained

---

### Step 6: Migrate Documentation (30min)

**Actions:**
- [ ] Move `VALIDATION-supabase-docs.md` ‚Üí `aios-fullstack/aios-core/data/validation-supabase-docs.md`
- [ ] Move `SCHEMA-COMPARISON-SQLITE-SUPABASE.md` ‚Üí `docs/architecture/schema-comparison-sqlite-supabase.md`
- [ ] Archive or convert `README.md` to docs (if needed)
- [ ] Update any references to moved files

**Validation:**
- ‚úÖ Documentation in correct locations
- ‚úÖ References updated
- ‚úÖ Knowledge base accessible

---

### Step 7: Test Integration (2h)

**Actions:**
- [ ] Test agent activation: `/AIOS/agents/db-sage`
- [ ] Test agent commands: `*help`, `*bootstrap`, `*env-check`
- [ ] Test task execution: Execute `db-bootstrap` via agent
- [ ] Test template loading: Use `create-doc` with `schema-design-tmpl.yaml`
- [ ] Verify path resolution: Check `.aios-core/` paths work
- [ ] Test agent discoverability: Verify agent appears in agent list

**Test Scenarios:**

**Scenario 1: Agent Activation**
```bash
/AIOS/agents/db-sage
# Should activate db-sage agent
# Should show agent persona and commands
```

**Scenario 2: Command Execution**
```bash
*help
# Should show all db-sage commands
*bootstrap
# Should execute db-bootstrap task
```

**Scenario 3: Task Execution**
```bash
*env-check
# Should execute db-env-check task
# Should validate environment variables
```

**Scenario 4: Template Usage**
```bash
*create-schema
# Should use create-doc with schema-design-tmpl.yaml
# Should generate schema design document
```

**Validation:**
- ‚úÖ Agent activates successfully
- ‚úÖ Commands execute correctly
- ‚úÖ Tasks execute via agent
- ‚úÖ Templates load correctly
- ‚úÖ Path resolution works
- ‚úÖ Agent discoverable

---

### Step 8: Verify 0 Gaps (30min)

**Actions:**
- [ ] Run gap detection: `node outputs/architecture-map/schemas/detect-gaps.js`
- [ ] Verify db-sage agent has 0 gaps
- [ ] Verify db-* tasks have 0 gaps
- [ ] Verify db-* templates have 0 gaps
- [ ] Document any remaining gaps (should be 0)

**Validation:**
- ‚úÖ Gap detection shows 0 gaps for db-sage entities
- ‚úÖ All entities properly integrated
- ‚úÖ No orphaned references

---

### Step 9: Update Documentation (1h)

**Actions:**
- [ ] Add db-sage to `aios-fullstack/aios-core/agents/README.md`
- [ ] Document db-sage capabilities in framework docs
- [ ] Update architecture docs with db-sage integration
- [ ] Create integration summary document

**Documentation Updates:**

**agents/README.md:**
```markdown
## Database Specialist

- **db-sage** üóÑÔ∏è - Database Architect & Operations Engineer
  - Supabase optimization
  - Schema design and migrations
  - RLS policies and security
  - Query optimization
```

**Validation:**
- ‚úÖ Documentation updated
- ‚úÖ Agent discoverable via docs
- ‚úÖ Capabilities documented

---

## Integration Checklist

### Pre-Integration
- [ ] Strategic decision made ‚úÖ (integrate into core, keep db-sage name)
- [ ] Integration mapping created ‚úÖ (this document)
- [ ] Story refined for integration ‚úÖ (in progress)

### Integration
- [ ] Agent file migrated
- [ ] 11 tasks migrated
- [ ] 6 templates migrated
- [ ] Configuration updated
- [ ] Documentation migrated

### Post-Integration
- [ ] Agent activation tested
- [ ] Tasks execution tested
- [ ] Templates loading tested
- [ ] 0 gaps verified
- [ ] Documentation updated

---

## Risk Assessment

### Low Risk ‚úÖ
- **File Format:** All artifacts match AIOS standards
- **Path Resolution:** Uses standard `.aios-core/` paths
- **Dependencies:** No external dependencies needed
- **Compatibility:** Agent format matches existing agents

### Medium Risk ‚ö†Ô∏è
- **Path Updates:** May need to verify paths after migration
- **Configuration:** Need to check if templates/tasks registries exist
- **Testing:** Comprehensive testing needed for all 11 tasks

### Mitigation
- Test each artifact individually
- Verify paths resolve correctly
- Test agent activation early
- Test task execution thoroughly

---

## Success Criteria

**Integration Complete When:**
- ‚úÖ db-sage agent activates via `/AIOS/agents/db-sage`
- ‚úÖ All 11 tasks execute successfully
- ‚úÖ All 6 templates load correctly
- ‚úÖ Agent discoverable via standard AIOS patterns
- ‚úÖ Gap detection shows 0 gaps for db-sage entities
- ‚úÖ Documentation updated
- ‚úÖ Core-config.yaml updated (if applicable)

**QA Target:** 90-95/100 quality score

---

## Estimated Effort

| Task | Estimated Time | Priority |
|------|----------------|----------|
| Audit existing artifacts | 1h | HIGH |
| Migrate agent file | 30min | HIGH |
| Migrate 11 tasks | 2h | HIGH |
| Migrate 6 templates | 1h | HIGH |
| Update configuration | 30min | HIGH |
| Migrate documentation | 30min | MEDIUM |
| Test integration | 2h | HIGH |
| Verify 0 gaps | 30min | HIGH |
| Update documentation | 1h | MEDIUM |
| **TOTAL** | **8.5h** | |

**With Buffer:** 8-12h (matches refined estimate)

---

## Integration Pattern

**Pattern:** Direct Integration (File Migration)

**Key Differences from Utility Integration:**
- **Utilities:** Add to agent dependencies, register in core-config
- **db-sage:** Migrate files, verify format, test execution

**Similarities:**
- Both require registration in core-config (if applicable)
- Both require documentation updates
- Both require gap verification
- Both follow proven integration patterns

---

## Next Steps

1. ‚úÖ **Strategic Decision Made** - Integrate into core, keep db-sage name
2. ‚úÖ **Integration Mapping Created** - This document
3. ‚è≥ **Story Refinement** - Update story file for integration (in progress)
4. ‚è≥ **Story Validation** - Validate refined story (target 85-90/100)
5. ‚è≥ **Implementation** - Execute integration workflow (8-12h)

---

**Mapping Created By:** Sarah (@po) - Product Owner  
**Date:** 2025-10-29  
**Status:** Ready for Development  
**Pattern:** Integration Story (80% work already done)


