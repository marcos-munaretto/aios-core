# Story 1.7: Phase 2 Configuration System - Heuristic Tuning

**Epic**: Hybrid-Ops: Pedro ValÃ©rio Mind Integration
**Status**: âœ… **VALIDATED & APPROVED** - Ready for Implementation
**Assignee**: Developer
**Story Points**: 5
**Estimated Duration**: 2-3 days

---

## User Story

As **Pedro ValÃ©rio**,
I want **configurable heuristic weights and thresholds**,
so that **I can calibrate the system based on real-world usage**.

---

## Acceptance Criteria

- [x] **AC1**: `config/heuristics.yaml` created with all weights/thresholds
- [x] **AC2**: Mind loader reads config on initialization
- [x] **AC3**: Hot-reload support (config changes without restart)
- [x] **AC4**: Validation prevents invalid configurations (weights sum checks)
- [x] **AC5**: Default values match Phase 1 hardcoded values
- [x] **AC6**: Documentation explains each parameter with examples

---

## Integration Verification

- [x] **IV1**: Changing config does not break existing agents
- [x] **IV2**: Invalid configs log warnings and use defaults
- [x] **IV3**: Config changes reflected immediately in agent decisions

---

## Tasks / Subtasks

### Phase A: Configuration Schema (1 day)

- [ ] **Task 1:** Create config/heuristics.yaml with all heuristic parameters (AC1, AC5)
  - [ ] Define YAML schema structure with version field
  - [ ] Add PV_BS_001 weights and thresholds (verify against heuristic-compiler.js:34-37)
  - [ ] Add PV_PA_001 weights and thresholds (verify against heuristic-compiler.js:105-110)
  - [ ] Add PV_PM_001 weights and thresholds (verify against heuristic-compiler.js:198-203)
  - [ ] Add validation section with strict_mode settings
  - [ ] Document each parameter with inline comments

- [ ] **Task 2:** Create config-validator.js utility (AC4)
  - [ ] Implement weight sum validation for each heuristic
  - [ ] Implement threshold range validation (0-1 bounds)
  - [ ] Implement required fields validation
  - [ ] Implement type validation (number vs string checks)
  - [ ] Return structured validation errors with field names

- [ ] **Task 3:** Create config-loader.js with hot-reload (AC2, AC3)
  - [ ] Implement loadConfig() function with YAML parsing
  - [ ] Implement singleton config cache
  - [ ] Implement fs.watch() for hot-reload monitoring
  - [ ] Add error handling for invalid YAML syntax
  - [ ] Add error handling for missing config file (fallback to defaults)
  - [ ] Implement callback mechanism for config change notifications

### Phase B: Integration (0.5 days)

- [ ] **Task 4:** Update heuristic-compiler.js to read from config (AC2)
  - [ ] Modify compile() method to accept config parameter
  - [ ] Update all three HEURISTIC_TEMPLATES to use config values
  - [ ] Keep existing hardcoded values as fallback defaults
  - [ ] Invalidate compiled function cache on config changes
  - [ ] Add logging for config usage vs defaults

- [ ] **Task 5:** Update mind-loader.js to load config first (AC2)
  - [ ] Load config before compiling heuristics
  - [ ] Pass config to heuristic compiler
  - [ ] Validate config before use
  - [ ] Support environment variable overrides
  - [ ] Log which config source was used (file, env vars, defaults)

### Phase C: Testing & Documentation (1 day)

- [ ] **Task 6:** Write configuration tests (AC4, AC5, IV1, IV2, IV3)
  - [ ] Test default values match heuristic-compiler.js hardcoded values
  - [ ] Test invalid config rejection (bad weights, missing fields, wrong types)
  - [ ] Test hot-reload functionality (config change detection)
  - [ ] Test environment variable overrides
  - [ ] Test existing agents not broken by config introduction (IV1)
  - [ ] Test invalid config fallback to defaults with warnings (IV2)
  - [ ] Test config changes reflected in agent decisions (IV3)

- [ ] **Task 7:** Create configuration documentation (AC6)
  - [ ] Write configuration-guide.md with all parameters documented
  - [ ] Write calibration-workflow.md with step-by-step process
  - [ ] Add parameter reference tables with ranges and descriptions
  - [ ] Add calibration guides for each heuristic
  - [ ] Add troubleshooting section for common config errors
  - [ ] Add example config presets (conservative, balanced, aggressive)

---

## Dev Notes

### Relevant Source Tree

```
.claude/commands/hybridOps/
â”œâ”€â”€ config/                          # â† NEW: Configuration directory
â”‚   â””â”€â”€ heuristics.yaml              # â† NEW: Heuristic tuning config
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ mind-loader.js               # â† MODIFY: Load config before compiling heuristics
â”‚   â”œâ”€â”€ heuristic-compiler.js        # â† MODIFY: Read weights/thresholds from config
â”‚   â”œâ”€â”€ config-loader.js             # â† NEW: Config loading + hot-reload
â”‚   â”œâ”€â”€ config-validator.js          # â† NEW: Config validation
â”‚   â””â”€â”€ axioma-validator.js          # âœ“ Existing (unchanged)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ mind-loading.test.js         # âœ“ Existing (Story 1.1)
â”‚   â”œâ”€â”€ tools.test.js                # âœ“ Existing (Story 1.6)
â”‚   â”œâ”€â”€ integration.test.js          # âœ“ Existing (Story 1.6)
â”‚   â””â”€â”€ config.test.js               # â† NEW: Configuration tests
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ cognitive-tools-guide.md     # âœ“ Existing (Story 1.6)
â”‚   â”œâ”€â”€ configuration-guide.md       # â† NEW: Config parameters guide
â”‚   â””â”€â”€ calibration-workflow.md      # â† NEW: Calibration process
â””â”€â”€ package.json                     # â† MODIFY: Add yaml dependency if needed
```

### Phase 1 Hardcoded Values (Verification)

**Source File**: `.claude/commands/hybridOps/utils/heuristic-compiler.js`

All default values in the config schema match Phase 1 hardcoded values:

**PV_BS_001** (heuristic-compiler.js:34-37):
- `end_state_vision` weight: **0.9** (line 34)
- `current_market_signals` weight: **0.1** (line 35)
- `confidence` threshold: **0.8** (line 36)
- `priority` threshold: **0.8** (line 37)

**PV_PA_001** (heuristic-compiler.js:105-110):
- `truthfulness` weight: **1.0** (line 105) - VETO POWER
- `system_adherence` weight: **0.8** (line 106)
- `skill` weight: **0.3** (line 107)
- `veto` threshold: **0.7** (line 108)
- `approve` threshold: **0.8** (line 109)
- `review` threshold: **0.6** (line 110)

**PV_PM_001** (heuristic-compiler.js:198-203):
- `frequency` weight: **0.7** (line 198)
- `standardization` weight: **0.9** (line 199)
- `guardrails` weight: **1.0** (line 200) - VETO POWER
- `tipping_point` threshold: **2** executions/month (line 201)
- `standardization` threshold: **0.7** (line 202)
- `automate` threshold: **0.75** (line 203)

### Configuration Schema Design

**File**: `.claude/commands/hybridOps/config/heuristics.yaml`

```yaml
# Heuristic Weights and Thresholds Configuration
# Version: 1.0
#
# All default values match Phase 1 hardcoded values in:
# utils/heuristic-compiler.js (lines 34-37, 105-110, 198-203)

version: "1.0"

heuristics:
  PV_BS_001:  # Future System Back-Casting
    weights:
      end_state_vision: 0.9        # Long-term vision clarity weight
      current_market_signals: 0.1  # Current market alignment weight
    thresholds:
      confidence: 0.8              # Min end-state clarity for "high" confidence
      priority: 0.8                # Min weighted score for "HIGH" priority

  PV_PA_001:  # Systemic Coherence Scan
    weights:
      truthfulness: 1.0            # VETO POWER - coherence assessment
      system_adherence: 0.8        # System fit weight
      skill: 0.3                   # Technical capability weight
    thresholds:
      veto: 0.7                    # Min truthfulness (below = REJECT)
      approve: 0.8                 # Min weighted score for "APPROVE"
      review: 0.6                  # Min weighted score for "REVIEW"

  PV_PM_001:  # Automation Tipping Point
    weights:
      frequency: 0.7               # Execution frequency weight
      standardization: 0.9         # Process standardization weight
      guardrails: 1.0              # VETO POWER - safety mechanisms
    thresholds:
      tipping_point: 2             # Executions/month threshold
      standardization: 0.7         # Min standardization for automation
      automate: 0.75               # Min weighted score to automate

validation:
  strict_mode: true                # Enforce validation rules
  minimum_score: 7.0               # Axioma validation threshold
  enable_veto: true                # Enable veto power checks
```

### Configuration Loader Implementation

**File**: `.claude/commands/hybridOps/utils/config-loader.js`

```javascript
const fs = require('fs');
const yaml = require('yaml');
const path = require('path');

let configCache = null;
let configWatcher = null;
const callbacks = [];

const CONFIG_PATH = path.join(__dirname, '..', 'config', 'heuristics.yaml');

/**
 * Load configuration from YAML file
 * @returns {Object} Parsed configuration
 * @throws {Error} If config file cannot be read or parsed
 */
function loadConfig() {
  try {
    const content = fs.readFileSync(CONFIG_PATH, 'utf-8');
    configCache = yaml.parse(content);
    console.log('âœ“ Loaded configuration from:', CONFIG_PATH);
    return configCache;
  } catch (error) {
    console.error('âŒ Failed to load configuration:', error.message);
    console.log('âš ï¸  Falling back to hardcoded defaults');
    return null; // Signal to use defaults
  }
}

/**
 * Get current configuration (cached or load fresh)
 * @returns {Object|null} Configuration or null if unavailable
 */
function getConfig() {
  if (!configCache) {
    return loadConfig();
  }
  return configCache;
}

/**
 * Watch configuration file for changes and trigger callbacks
 * @param {Function} callback - Called when config changes
 */
function watchConfig(callback) {
  if (configWatcher) {
    console.log('âš ï¸  Config watcher already active');
    return;
  }

  callbacks.push(callback);

  configWatcher = fs.watch(CONFIG_PATH, (eventType, filename) => {
    if (eventType === 'change') {
      console.log('ðŸ”„ Configuration file changed, reloading...');

      const oldConfig = configCache;
      configCache = null;  // Invalidate cache

      try {
        const newConfig = loadConfig();

        // Notify all callbacks
        callbacks.forEach(cb => {
          try {
            cb(newConfig, oldConfig);
          } catch (err) {
            console.error('âŒ Config callback error:', err);
          }
        });
      } catch (error) {
        console.error('âŒ Failed to reload config:', error.message);
      }
    }
  });

  console.log('ðŸ‘ï¸  Watching configuration file for changes');
}

/**
 * Stop watching configuration file
 */
function unwatchConfig() {
  if (configWatcher) {
    configWatcher.close();
    configWatcher = null;
    callbacks.length = 0;
    console.log('âœ“ Stopped watching configuration file');
  }
}

/**
 * Reload configuration immediately (for testing)
 */
function reloadConfig() {
  configCache = null;
  return loadConfig();
}

module.exports = {
  loadConfig,
  getConfig,
  watchConfig,
  unwatchConfig,
  reloadConfig
};
```

### Configuration Validator Implementation

**File**: `.claude/commands/hybridOps/utils/config-validator.js`

```javascript
/**
 * Validate heuristic configuration
 * @param {Object} config - Configuration object to validate
 * @returns {Object} Validation result with {valid: boolean, errors: string[]}
 */
function validateConfig(config) {
  const errors = [];

  if (!config) {
    return { valid: false, errors: ['Configuration object is required'] };
  }

  // Validate version
  if (!config.version) {
    errors.push('Missing required field: version');
  }

  // Validate heuristics section
  if (!config.heuristics) {
    errors.push('Missing required field: heuristics');
    return { valid: false, errors };
  }

  // Validate each heuristic
  ['PV_BS_001', 'PV_PA_001', 'PV_PM_001'].forEach(heuristicId => {
    const h = config.heuristics[heuristicId];

    if (!h) {
      errors.push(`Missing heuristic: ${heuristicId}`);
      return;
    }

    // Validate weights
    if (!h.weights) {
      errors.push(`${heuristicId}: Missing weights section`);
    } else {
      Object.entries(h.weights).forEach(([key, value]) => {
        if (typeof value !== 'number') {
          errors.push(`${heuristicId}.weights.${key}: Must be a number`);
        }
        if (value < 0) {
          errors.push(`${heuristicId}.weights.${key}: Cannot be negative`);
        }
      });
    }

    // Validate thresholds
    if (!h.thresholds) {
      errors.push(`${heuristicId}: Missing thresholds section`);
    } else {
      Object.entries(h.thresholds).forEach(([key, value]) => {
        if (typeof value !== 'number') {
          errors.push(`${heuristicId}.thresholds.${key}: Must be a number`);
        }
        // Most thresholds are 0-1 range (except tipping_point which is integer)
        if (key !== 'tipping_point' && (value < 0 || value > 1)) {
          errors.push(`${heuristicId}.thresholds.${key}: Must be between 0 and 1`);
        }
      });
    }
  });

  // Validate validation section
  if (config.validation) {
    if (typeof config.validation.strict_mode !== 'boolean') {
      errors.push('validation.strict_mode: Must be boolean');
    }
    if (typeof config.validation.minimum_score !== 'number') {
      errors.push('validation.minimum_score: Must be number');
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

module.exports = {
  validateConfig
};
```

### Environment Variable Overrides

Configuration parameters can be overridden via environment variables:

```bash
# Override specific weights
export HEURISTIC_BS001_END_STATE_WEIGHT=0.95
export HEURISTIC_PA001_VETO_THRESHOLD=0.75

# Override validation settings
export VALIDATION_STRICT_MODE=false
export VALIDATION_MINIMUM_SCORE=6.0

# Override config file location
export HEURISTICS_CONFIG_PATH=/custom/path/heuristics.yaml
```

**Implementation**: Update config-loader.js to check environment variables before using file values.

### Security Considerations

**Configuration File Security:**
- âœ… **Version Control**: `config/heuristics.yaml` SHOULD be committed (contains system defaults, not secrets)
- âš ï¸ **Production Overrides**: Use environment variables for production-specific calibrations (do NOT commit)
- âš ï¸ **Access Control**: Ensure only authorized users can modify config files on production servers
- âœ… **Validation**: All config values validated before use to prevent injection attacks
- âœ… **Audit Logging**: Log all config changes with timestamps (via git or application logs)

**Secrets Handling:**
- No secrets or credentials in heuristics.yaml
- No API keys or tokens in configuration
- No personally identifiable information (PII)

**Git Configuration:**
- Commit: `config/heuristics.yaml` (system defaults)
- DO NOT commit: `config/heuristics.local.yaml` (if created for local testing)
- Add to .gitignore: `config/*.local.yaml`

### Testing

#### Test Framework

- **Framework**: Node.js built-in test runner (`node --test`)
- **Test File**: `.claude/commands/hybridOps/tests/config.test.js`
- **Pattern**: Arrange-Act-Assert
- **Coverage Target**: â‰¥90% for config utilities

#### Test Running

```bash
cd .claude/commands/hybridOps
npm test -- tests/config.test.js
```

#### Test Categories

1. **Default Value Tests**: Verify config defaults match heuristic-compiler.js hardcoded values
2. **Validation Tests**: Test rejection of invalid configs (weights, thresholds, types)
3. **Hot-Reload Tests**: Test config change detection and callback triggering
4. **Environment Variable Tests**: Test env var overrides
5. **Integration Tests**: Test existing agents work with config system (IV1, IV2, IV3)

---

## Configuration Parameters Reference

### PV_BS_001: Future System Back-Casting

| Parameter | Default | Range | Description | Source |
|-----------|---------|-------|-------------|--------|
| `end_state_vision` | 0.9 | 0.0-1.0 | Weight for long-term vision clarity | heuristic-compiler.js:34 |
| `current_market_signals` | 0.1 | 0.0-1.0 | Weight for current market alignment | heuristic-compiler.js:35 |
| `confidence` threshold | 0.8 | 0.0-1.0 | Minimum end-state clarity for "high" confidence | heuristic-compiler.js:36 |
| `priority` threshold | 0.8 | 0.0-1.0 | Minimum weighted score for "HIGH" priority | heuristic-compiler.js:37 |

**Calibration Guide:**
- **Increase `end_state_vision`**: When vision is exceptionally clear (>0.9 typical)
- **Increase `current_market_signals`**: When market timing is critical
- **Adjust `confidence`**: Based on historical accuracy at different clarity levels

### PV_PA_001: Systemic Coherence Scan

| Parameter | Default | Range | Description | Source |
|-----------|---------|-------|-------------|--------|
| `truthfulness` | 1.0 | 0.7-1.5 | Weight for truthfulness (VETO POWER) | heuristic-compiler.js:105 |
| `system_adherence` | 0.8 | 0.0-1.0 | Weight for system fit | heuristic-compiler.js:106 |
| `skill` | 0.3 | 0.0-1.0 | Weight for technical capability | heuristic-compiler.js:107 |
| `veto` threshold | 0.7 | 0.5-0.9 | Minimum truthfulness (below = REJECT) | heuristic-compiler.js:108 |
| `approve` threshold | 0.8 | 0.6-1.0 | Minimum weighted score for "APPROVE" | heuristic-compiler.js:109 |
| `review` threshold | 0.6 | 0.4-0.8 | Minimum weighted score for "REVIEW" | heuristic-compiler.js:110 |

**Calibration Guide:**
- **Adjust `veto`**: Based on false rejection rate
  - Too high (>0.8): May reject good people with minor truthfulness issues
  - Too low (<0.6): May approve incoherent people
- **Rebalance weights**: If skill matters more in specific contexts
  - Default: Coherence > Capability (PV principle)
  - Alternative: Increase `skill` weight for technical roles

### PV_PM_001: Automation Tipping Point

| Parameter | Default | Range | Description | Source |
|-----------|---------|-------|-------------|--------|
| `frequency` | 0.7 | 0.0-1.0 | Weight for execution frequency | heuristic-compiler.js:198 |
| `standardization` | 0.9 | 0.0-1.0 | Weight for process standardization | heuristic-compiler.js:199 |
| `guardrails` | 1.0 | 0.5-1.5 | Weight for safety mechanisms (VETO POWER) | heuristic-compiler.js:200 |
| `tipping_point` | 2 | 1-10 | Executions/month threshold | heuristic-compiler.js:201 |
| `standardization` threshold | 0.7 | 0.5-0.9 | Minimum standardization for automation | heuristic-compiler.js:202 |
| `automate` threshold | 0.75 | 0.5-0.9 | Minimum weighted score to automate | heuristic-compiler.js:203 |

**Calibration Guide:**
- **Adjust `tipping_point`**: Based on automation ROI
  - Lower (1): Automate more aggressively
  - Higher (5): Only automate very frequent tasks
- **Adjust `standardization`**: Based on process variability
  - Lower (0.5): Accept more variability
  - Higher (0.9): Require near-perfect standardization

---

## Dependencies

- Story 1.6 complete (all heuristics in use, tools deployed)
- YAML parser: `yaml@^2.3.4` (verify in package.json or add)
- Configuration schema designed and validated per this story

---

## Success Metrics

- **Flexibility**: All hardcoded values externalized to config âœ“
- **Validation**: Invalid configs caught before use âœ“
- **Hot-Reload**: Config changes applied without restart (<5s) âœ“
- **Documentation**: 100% of parameters documented with examples âœ“
- **Usability**: Pedro can calibrate without developer assistance âœ“

---

## Risks and Mitigation

**Risk 1**: Invalid config crashes system
- **Mitigation**: Comprehensive validation before use (config-validator.js)
- **Fallback**: Use defaults on validation failure
- **Logging**: Clear error messages for config issues

**Risk 2**: Config changes have unexpected side effects
- **Mitigation**: Version config file (version: "1.0" field)
- **Testing**: Integration tests with different configs (IV1, IV2, IV3)
- **Rollback**: Git tracks config changes for easy rollback

**Risk 3**: Too many parameters overwhelm users
- **Mitigation**: Sensible defaults that work for 90% of cases
- **Documentation**: "Getting Started" guide focuses on key parameters
- **Presets**: Provide pre-configured profiles (conservative, balanced, aggressive)

---

## File List

**To Create:**
- `.claude/commands/hybridOps/config/heuristics.yaml`
- `.claude/commands/hybridOps/utils/config-loader.js`
- `.claude/commands/hybridOps/utils/config-validator.js`
- `.claude/commands/hybridOps/tests/config.test.js`
- `.claude/commands/hybridOps/docs/configuration-guide.md`
- `.claude/commands/hybridOps/docs/calibration-workflow.md`

**To Modify:**
- `.claude/commands/hybridOps/utils/heuristic-compiler.js` (read from config via config parameter)
- `.claude/commands/hybridOps/utils/mind-loader.js` (load config first, pass to compiler)
- `.claude/commands/hybridOps/package.json` (add yaml dependency if not present)

---

## Notes

This configuration system enables **continuous improvement** without code changes:
1. Deploy with safe defaults (matching Phase 1 values)
2. Collect validation metrics from real-world usage
3. Identify calibration needs based on false positive/negative rates
4. Adjust config parameters incrementally
5. Monitor impact of changes via agent decisions
6. Iterate based on results

Key principle: **Make calibration a workflow, not a rebuild.**

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.1 | Story restructuring: Added Tasks/Subtasks checkboxes, Testing section, Source Tree, verified default values against heuristic-compiler.js, added Change Log, Dev Agent Record, QA Results sections per template validation | Sarah (PO) |
| 2025-01-18 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

**Implementation completed successfully with all acceptance criteria met.**

### Agent Model Used

- **Model**: Claude Sonnet 4.5 (`claude-sonnet-4-5-20250929`)
- **Context**: Story-driven development with AIOS-FULLSTACK framework
- **Session**: Continued session after context limit

### Debug Log References

**Test Execution Results:**
```
All 13 configuration tests passed successfully!

Coverage:
  âœ“ Configuration validation (6 tests)
  âœ“ Configuration loading (2 tests)
  âœ“ Environment variable overrides (1 test)
  âœ“ Compiler integration (2 tests)
  âœ“ Cache and performance (2 tests)

Phase 2 Configuration System is ready for production!
```

**Configuration Loading Logs:**
```
âœ“ Loaded configuration from: .claude/commands/hybridOps/config/heuristics.yaml
âœ“ Configuration validated successfully
ðŸ”§ Compiling heuristic: PV_BS_001 (Future System Back-Casting)
   Source: Configuration file
ðŸ”§ Compiling heuristic: PV_PA_001 (Systemic Coherence Scan)
   Source: Configuration file
ðŸ”§ Compiling heuristic: PV_PM_001 (Automation Tipping Point)
   Source: Configuration file
```

### Completion Notes

**Implementation Approach:**
1. Created configuration schema in YAML with exact Phase 1 default values
2. Implemented strict validation with type checking and heuristic-specific rules
3. Built config loader with hot-reload using fs.watch() for immediate updates
4. Enhanced heuristic-compiler.js with config-driven compilation and cache invalidation
5. Integrated configuration system into mind-loader.js with 3-level fallback (file â†’ env â†’ defaults)
6. Removed 191 lines of obsolete internal compilation methods from mind-loader.js
7. Created comprehensive test suite with 13 tests (all passing)
8. Documented all parameters in configuration-guide.md
9. Created calibration-workflow.md with step-by-step process

**Key Design Decisions:**
- **Hot-Reload**: fs.watch() with callback notification system allows zero-downtime config updates
- **Validation First**: Invalid configs are rejected and previous config retained for safety
- **Environment Overrides**: 18 env vars support production tuning without file changes
- **Fallback Chain**: File â†’ Env+File â†’ Defaults ensures system always works
- **Cache Invalidation**: Config changes trigger automatic heuristic recompilation
- **External Compiler**: Removed duplicate internal methods, now uses heuristic-compiler exclusively

**Platform-Specific Notes:**
- Used `cmd /c` prefix for Windows mkdir commands
- Forward slashes in node test execution paths for cross-platform compatibility

### File List

**Files Created:**
1. `.claude/commands/hybridOps/config/heuristics.yaml` (86 lines)
   - Central configuration file with all heuristic weights and thresholds

2. `.claude/commands/hybridOps/utils/config-validator.js` (248 lines)
   - Comprehensive validation with type checking and heuristic-specific rules

3. `.claude/commands/hybridOps/utils/config-loader.js` (119 lines)
   - Config loading with hot-reload and cache invalidation

4. `.claude/commands/hybridOps/tests/config/config.test.js` (367 lines)
   - 13 tests covering validation, loading, env vars, compiler integration, and caching

5. `.claude/commands/hybridOps/docs/configuration-guide.md` (476 lines)
   - User guide with parameter reference, env var documentation, and troubleshooting

6. `.claude/commands/hybridOps/docs/calibration-workflow.md` (566 lines)
   - Step-by-step calibration process with examples and anti-patterns

**Files Modified:**
1. `.claude/commands/hybridOps/utils/heuristic-compiler.js`
   - Added `invalidateOnConfigChange()` method for hot-reload support
   - Enhanced `compile()` method to support config-driven compilation
   - Added logging for configuration source tracking

2. `.claude/commands/hybridOps/utils/mind-loader.js`
   - Added `loadConfiguration()` method with validation
   - Added `applyEnvironmentOverrides()` method with 18 env var mappings
   - Added `setupConfigHotReload()` method for automatic recompilation
   - Updated `compileHeuristics()` to use external compiler with config
   - **Removed 191 lines**: Deleted obsolete internal compilation methods
     - Removed `compileHeuristic()` - now uses external compiler
     - Removed `extractHeuristicConfig()` - no longer needed
     - Removed `createBackCastingFunction()` - algorithm in compiler
     - Removed `createCoherenceScanFunction()` - algorithm in compiler
     - Removed `createAutomationCheckFunction()` - algorithm in compiler

**Total Lines:**
- Created: 1,862 lines (6 new files)
- Modified: ~100 lines added, 191 lines removed (2 files)
- Net: +1,771 lines

---

## QA Results

**Reviewer:** Quinn (QA Agent)
**Review Date:** 2025-10-19
**Test Execution:** All 13 tests PASSED
**Quality Score:** 9.0/10
**Gate Status:** PASS
**Recommended Status:** âœ… READY FOR DONE

### Code Quality Assessment

**Architecture Strengths:**
- Excellent separation of concerns (validation, loading, compilation)
- Proper use of singleton pattern for caching
- Observer pattern for hot-reload notifications
- Graceful 3-level fallback chain (file â†’ env+file â†’ defaults)
- Complete external configuration decoupling

**Code Patterns:**
- Consistent error handling with try-catch throughout
- JSDoc comments for all public functions
- Proper yaml.parse() usage with YAMLParseError handling
- Environment variable naming convention: `HEURISTIC_{ID}_{PARAM}`
- Formatted validation errors via formatValidationErrors()

**Documentation Quality:**
- Exceptional inline comments in heuristics.yaml (ranges, descriptions, constraints)
- Comprehensive 476-line configuration guide with parameter reference
- Complete 566-line calibration workflow with examples and anti-patterns
- 18 environment variables fully documented
- Troubleshooting guide with common issues and solutions

### Refactoring Performed

No refactoring required during review. The implementation is clean and follows established patterns.

**Minor Enhancement Opportunities Identified (for future stories):**
1. Extract magic number 0.01 tolerance to named constant in config-validator.js:165
2. Add explicit file permission checks for security hardening
3. Add hot-reload edge case tests (concurrent changes, multiple watchers)
4. Consider structured logging (Winston/Pino) when logging strategy defined

### Compliance Check

**Coding Standards:** âœ… PASS
- Follows AIOS-FULLSTACK patterns consistently
- Proper error handling in all code paths
- JSDoc comments present
- No inappropriate emoji usage (only in console logs for UX)

**Project Structure:** âœ… PASS
- Config files in `.claude/commands/hybridOps/config/` âœ“
- Utilities in `.claude/commands/hybridOps/utils/` âœ“
- Tests in `.claude/commands/hybridOps/tests/config/` âœ“
- Documentation in `.claude/commands/hybridOps/docs/` âœ“

**Testing Strategy:** âœ… PASS
- Unit tests for validation logic (6 tests)
- Integration tests for compiler integration (2 tests)
- Edge case coverage (missing file, invalid YAML, negative values)
- 100% test pass rate before marking complete

**Acceptance Criteria:** âœ… ALL MET
- AC1: config/heuristics.yaml created âœ“ (Test 7)
- AC2: Mind loader reads config âœ“ (Tests 10-11)
- AC3: Hot-reload support âœ“ (Test 13)
- AC4: Validation prevents invalid configs âœ“ (Tests 2-6)
- AC5: Default values match Phase 1 âœ“ (Test 11, verified against heuristic-compiler.js:34-37, 105-110, 198-203)
- AC6: Documentation explains parameters âœ“ (configuration-guide.md, calibration-workflow.md)

**Integration Verification:** âœ… ALL VALIDATED
- IV1: Config changes don't break agents âœ“ (strict validation + fallback)
- IV2: Invalid configs log warnings âœ“ (Test 8, console logs verified)
- IV3: Config changes reflected immediately âœ“ (Test 13, fs.watch() + cache invalidation)

### Improvements Checklist

**Requirements Traceability:** âœ… 100%
- All 6 ACs mapped to implementation and tests
- All 3 IVs validated with evidence
- Clear Given-When-Then test patterns

**Test Architecture:** âœ… Strong (8/10)
- 13 tests across 5 suites with 100% pass rate
- Good coverage of core functionality
- Deterministic, fast, reliable tests
- Minor gaps in edge cases (noted for future)

**NFR Validation:**
- Security: âœ… Good (8/10) - YAML bomb protection, input validation, safe path handling
- Performance: âœ… Excellent (9/10) - Caching, event-driven hot-reload, lazy loading
- Reliability: âœ… Excellent (10/10) - 3-level fallback, error recovery, comprehensive logging
- Maintainability: âœ… Excellent (10/10) - External config, exceptional docs, clean modularity

**Testability:** âœ… Excellent (9/10)
- High controllability (env vars, config file swapping)
- High observability (comprehensive logging, config source tracking)
- High debuggability (line numbers in errors, detailed validation messages)

**Technical Debt:** âœ… Minimal (Low Impact)
- Only minor enhancements identified (magic numbers, permission checks, edge case tests)
- No blocking issues
- All debt items documented for future stories

### Security Review

**Strengths:**
- No credentials in configuration (guide documents env var usage)
- YAML bomb protection via yaml.parse() v2.3.4
- Path traversal prevention via path.join(__dirname)
- Strict input validation prevents injection attacks

**Minor Enhancement:**
- Add explicit file permission checks on config file (future story)

**Security Assessment:** APPROVED for production

### Performance Considerations

**Optimizations Present:**
- Configuration cached after first load (singleton pattern)
- Compiled heuristics cached by compiler
- Event-driven hot-reload (no polling overhead)
- Selective cache invalidation on config change
- Lazy loading (config only loaded when needed)

**Performance Assessment:** Excellent, no concerns

### Files Modified During Review

None. No refactoring required.

### Gate Details

**Decision:** PASS
**Reason:** High-quality implementation fully meeting all acceptance criteria with exceptional documentation

**Top Strengths:**
1. 100% requirements traceability with clear test coverage
2. Exceptional documentation (1,042 lines total)
3. Robust validation with heuristic-specific rules
4. Zero-downtime hot-reload implementation
5. Excellent reliability with 3-level fallback chain

**Recommendations:**

**Immediate (before merging):** None - implementation is production-ready

**Future Enhancements:**
1. Add file permission security checks (Story 1.8 candidate)
2. Extract magic numbers to named constants (minor refactor)
3. Add hot-reload edge case tests (test enhancement)
4. Consider structured logging framework (when logging strategy defined)

---

**Quality Gate File:** `docs/qa/gates/1.7-phase-2-configuration-system.yml`

---

**Related Documents:**
- PRD: `docs/prd/epic-1-hybrid-ops-pedro-valerio-integration.md` (original requirements)
- Architecture: `docs/architecture/07-configuration-management.md` (configuration patterns)
- Source Code: `.claude/commands/hybridOps/utils/heuristic-compiler.js` (Phase 1 hardcoded values)
- Mind Artifacts: `outputs/minds/pedro_valerio/` (behavioral evidence for default values)
